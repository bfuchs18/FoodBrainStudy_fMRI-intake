---
title: "descriptive and exploratory analyses"
author: "baf44"
date: "2023-08-02"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Set up

```{r load packages }
# load packages
library(data.table)
library(table1)
library(ggplot2)
library(corrplot)
library(tidyr) # to use "gather()"
library(Hmisc) # to plot all histograms in a dataframe
library(RcmdrMisc)
library(matrixcalc)
library(psych)
library(EnvStats) # for rosnerTest()
```

```{r load generated datasets, include=FALSE}

source("code/gen_fmri_index.R") # this sources setup_data.R, feis_portionsize.R, gen_fmri_covtable.R, determine_analysis_sample.R

```

```{r change -999 to NA , include=FALSE}

# Replace all occurrences of -999 with NA
fmri_covariates[fmri_covariates == -999] <- NA

```

## Determine samples

```{r participant sample, include=TRUE}

# count number of children who attended V6
nrow(r01_V6)

```

```{r analysis sample, include=TRUE}

# combine subset dfs (generated by gen_fmri_index.R) into list
subset_analyses_lists <- list(subset_lin_app_b20, subset_quad_app_b20, subset_fr_app_b20, subset_sr_app_b20, subset_lin_cer_b20, subset_quad_cer_b20, subset_fr_cer_b20, subset_sr_cer_b20)

# Extract the "sub" column from all dataframes and combine into a single vector, get unique values
fmri_subs_included <- unique(unlist(lapply(subset_analyses_lists, function(df) df$sub)))

# count number of subjects included in any fmri analysis
length(fmri_subs_included)

```

```{r sample size by fmri analysis, include=TRUE}

# check number of subjects in subset dataframes (generated by gen_fmri_index.R)
nrow(subset_lin_app_b20)
nrow(subset_quad_app_b20) # quadtratic + vertex analyses (with outliers)
nrow(subset_fr_app_b20)
nrow(subset_sr_app_b20)
#nrow(subset_g_vertex_app_b20) # vertex analyses without outliers
#nrow(subset_kcal_vertex_app_b20) # vertex analyses without outliers

nrow(subset_lin_cer_b20)
nrow(subset_quad_cer_b20) # quadtratic + vertex analyses (with outliers)
nrow(subset_fr_cer_b20)
nrow(subset_sr_cer_b20)
#nrow(subset_g_vertex_cer_b20) # vertex analyses without outliers
#nrow(subset_kcal_vertex_cer_b20) # vertex analyses without outliers
```

Compared to subset_lin_app, subset_quad_app is missing subs "128", "058", "083". -- These subjects do not have FEIS estimates from quadratic models because they are missing intake measurements for 1 meal.

## Subset for analyses

```{r subset based on sample, include=TRUE}

# Subset r01_demo based on values in fmri_subs_included
subset_r01_demo <- r01_demo[r01_demo$sub %in% fmri_subs_included, ]
participants_r01_demo <- r01_demo[r01_demo$sub %in% r01_V6$sub, ]
analyzed_r01_demo <- r01_demo[r01_demo$sub %in% fmri_subs_included, ]

# add analyzed column
participants_r01_demo$analyzed <- ifelse(participants_r01_demo$sub %in% fmri_subs_included, 1, 0)

```


## Table 1 - demographics and imaging covariates by inclusion status

```{r imaging covariates, include=TRUE}

# Add variables used as MRI covariates to participants_r01_demo
participants_r01_demo <- merge(participants_r01_demo, fd[, c("sub", "fd_avg_allruns")], by = "sub", all.x = TRUE)
participants_r01_demo <- merge(participants_r01_demo, impute_data[, c("sub", "pre_mri_ff")], by = "sub", all.x = TRUE) #impute data is generated in gen_fmri_covtable. It includes all subs who attended V6, and does not contain the imputed pre-mri fullness value
participants_r01_demo <- merge(participants_r01_demo, r01_V6[, c("sub", "cams_pre_mri")], by = "sub", all.x = TRUE)


## assess distributions
hist(participants_r01_demo$pre_mri_ff)
hist(participants_r01_demo$cams_pre_mri)
hist(participants_r01_demo$fd_avg_allruns)
ks.test(participants_r01_demo$pre_mri_ff, "pnorm", mean=mean(fmri_covariates$pre_mri_ff, na.rm = TRUE), sd=sd(fmri_covariates$pre_mri_ff, na.rm = TRUE))
ks.test(participants_r01_demo$cams_pre_mri, "pnorm", mean=mean(fmri_covariates$cams_pre_mri, na.rm = TRUE), sd=sd(fmri_covariates$cams_pre_mri, na.rm = TRUE))
ks.test(participants_r01_demo$fd_avg_allruns, "pnorm", mean=mean(fmri_covariates$fd_avg_allruns, na.rm = TRUE), sd=sd(fmri_covariates$fd_avg_allruns, na.rm = TRUE))

```


```{r make table, include=TRUE}

# make mom_edu variable with 3 levels -- combine technical degree + high school into < Bachelor
participants_r01_demo$mom_ed_3categories <- participants_r01_demo$mom_ed
participants_r01_demo$mom_ed_3categories[participants_r01_demo$mom_ed_3categories == "AA/Technical Degree"] <- "< Bachelor Degree"
participants_r01_demo$mom_ed_3categories[participants_r01_demo$mom_ed_3categories == "High School/GED"] <- "< Bachelor Degree"

# prepare variables
participants_r01_demo$analyzed <- factor(participants_r01_demo$analyzed, levels=c(1,0),
         labels=c("Included", 
                  "Excluded"))

# reorder levels
participants_r01_demo$mom_ed_3categories <- factor(participants_r01_demo$mom_ed_3categories, levels=c("< Bachelor Degree", "Bachelor Degree", "> Bachelor Degree"))
participants_r01_demo$income <- factor(participants_r01_demo$income, levels=c("< $51,000", "$51,000 - $100,000", ">$100,000"))


# assign labels for table1()
label(participants_r01_demo$sex) <- "Sex"
label(participants_r01_demo$race) <- "Race"
label(participants_r01_demo$ethnicity) <- "Ethnicity"
label(participants_r01_demo$age_yr) <- "Age, yrs"
label(participants_r01_demo$income) <- "Family Income"
label(participants_r01_demo$bmi_percentile) <- "BMI percentile"
label(participants_r01_demo$mom_ed_3categories) <- "Maternal Education"
label(participants_r01_demo$cams_pre_mri) <- "pre-MRI anxiety"
label(participants_r01_demo$pre_mri_ff) <- "pre-MRI fullness"
label(participants_r01_demo$fd_avg_allruns) <- "Average framewise displacement"

# generate table
table1(~ sex + age_yr + race + ethnicity + income + mom_ed_3categories+ bmi_percentile + pre_mri_ff + cams_pre_mri + fd_avg_allruns| analyzed, data=participants_r01_demo, overall = F)

# get quartiles for pre-MRI anxiety and FD by group (variables are non-normally distributed)
tapply(participants_r01_demo$cams_pre_mri, participants_r01_demo$analyzed, summary)
tapply(participants_r01_demo$fd_avg_allruns, participants_r01_demo$analyzed, summary)

```


```{r comparisons by inclusion status, include=TRUE}

# sex
chisq.test(participants_r01_demo$analyzed, participants_r01_demo$sex, correct=TRUE)

# age
t.test(participants_r01_demo$age_yr ~ participants_r01_demo$analyzed, var.equal = FALSE)

# race
fisher.test(participants_r01_demo$analyzed, participants_r01_demo$race)

# income
fisher.test(participants_r01_demo$analyzed, participants_r01_demo$income)

# maternal education
chisq.test(participants_r01_demo$analyzed, participants_r01_demo$mom_ed_3categories, correct=TRUE)

# BMI %tile
t.test(participants_r01_demo$bmi_percentile ~ participants_r01_demo$analyzed, var.equal = FALSE)

# pre-mri anxiety
t.test(participants_r01_demo$cams_pre_mri ~ participants_r01_demo$analyzed, var.equal = FALSE)
wilcox.test(cams_pre_mri ~ analyzed,
                   data = participants_r01_demo,
                   exact = FALSE)

# FD
t.test(participants_r01_demo$fd_avg_allruns ~ participants_r01_demo$analyzed, var.equal = FALSE)
wilcox.test(fd_avg_allruns ~ analyzed,
                   data = participants_r01_demo,
                   exact = FALSE)

# pre-mri fullness
t.test(participants_r01_demo$pre_mri_ff ~ participants_r01_demo$analyzed, var.equal = FALSE)


```


## Meal intake variables (data for FEIS models)

```{r table: descriptive stats, include=TRUE}
# Note: intake_long_analyze was generated by feis_portionsize.R. It only contains subjects who were included in FEIS analyses 

# assign labels for table1()
label(intake_long_analyze$grams) <- "Total intake, grams"
label(intake_long_analyze$kcal) <- "Total intake, kcal"
label(intake_long_analyze$preFF) <- "Pre-meal fullness"
label(intake_long_analyze$avg_vas) <- "Average liking"

# generate table
table1(~ grams + kcal + avg_vas + preFF | PortionSize, data=intake_long_analyze, overall=F)

```

## Eating behavior variables

Descriptive statistics for linear and quadratic portion size slopes and CEBQ variables

```{r table: slope and CEBQ descriptives, include=TRUE}

# subset_fmri_covariates

# assign labels for table1()
label(fmri_covariates$l_grams_ps_lin) <- "linear portion size slope, g"
label(fmri_covariates$l_kcal_ps_lin) <- "linear portion size slope, kcal"
label(fmri_covariates$q_grams_ps_quad) <- "quadratic portion size slope, g"
label(fmri_covariates$q_kcal_ps_quad) <- "quadratic portion size slope, kcal"
label(fmri_covariates$cebq_fr) <- "food responsiveness"
label(fmri_covariates$cebq_sr) <- "satiety responsiveness"

# generate table
table1(~ l_grams_ps_lin + l_kcal_ps_lin + q_grams_ps_quad + q_kcal_ps_quad + cebq_fr + cebq_sr, data=fmri_covariates)

```

Descriptive statistics for vertex by quadratic portion size slope sign (+/-)

```{r table: vertex by quad sign, include=TRUE}

# setup
fmri_covariates$quad_sign_gram <- factor(subset_fmri_covariates$quad_sign_gram, levels=c(0,1),
                            labels=c("Negative Quadratic Slope", "Positive Quadratic Slope"))

fmri_covariates$quad_sign_kcal <- factor(subset_fmri_covariates$quad_sign_kcal, levels=c(0,1),
                            labels=c("Negative Quadratic Slope", "Positive Quadratic Slope"))


# Count the number of negative ( = 0) and positive ( = 1) quadratic portion size slopes
quad_sign_table_grams <- xtabs(~ quad_sign_gram, data = fmri_covariates) # grams
quad_sign_table_kcal <- xtabs(~ quad_sign_kcal, data = fmri_covariates) # kcal

quad_sign_table_grams
quad_sign_table_kcal

# Count the % of negative ( = 0) and positive ( = 1) quadratic portion size slopes
percent_quad_sign_grams <- prop.table(quad_sign_table_grams) * 100
percent_quad_sign_kcal <- prop.table(quad_sign_table_kcal) * 100

percent_quad_sign_grams
percent_quad_sign_kcal

# subset to include subjects included in quadratic analyses
subset_quad_analyses <- fmri_covariates[subset_fmri_covariates$sub %in% subset_quad_cer_b20$sub, ]

#### Table with outliers - use quartiles ####

# define function for render
render.NEW <- function(x, name, data2, ...) {
    MIN <- min(x, na.rm = T)
    MAX <- max(x, na.rm = T)
    median <- median(x, na.rm = T)
    Q1 <- quantile(x, 0.25, na.rm = T)
    Q3 <- quantile(x, 0.75, na.rm = T)
    N = length(x) - sum(is.na(x))
    
    out <- c("","N" = N,
             "min, max" = paste0(sprintf("%.2f", MIN), ", ", sprintf("%.2f", MAX)),
             "Median [Q1, Q3]" = paste0(sprintf("%.2f", median), " [", sprintf("%.2f", Q1), ", ", sprintf("%.2f", Q3), "]"))
    out
}

# generate tables -- all subs with vertices
table1(~ g_vertex | quad_sign_gram , data=subset_quad_analyses, render = render.NEW)
table1(~ kcal_vertex | quad_sign_kcal , data=subset_quad_analyses, render = render.NEW)

#### Table without outliers - use means ####

# remove subs w/out vertex estimates (g_vertex = -999) and g vertex outliers ("094", "129", "043", "121", "089")
subset_vertex_no_outliers_g <- fmri_covariates %>% filter(!is.na(kcal_vertex), !sub %in% c("094", "129", "043", "121", "089"))

# remove subs w/out quad estimates (kcal_vertex = -999) and kcal vertex outliers ("109", "126", "043")
subset_vertex_no_outliers_kcal <- fmri_covariates %>% filter(!is.na(kcal_vertex), !sub %in% c("109", "126", "043"))

table1(~ g_vertex | quad_sign_gram , data=subset_vertex_no_outliers_g, )
table1(~ kcal_vertex | quad_sign_kcal , data=subset_vertex_no_outliers_kcal)

```


# Exploratory analyses

```{r overall PSE, include=TRUE}

# overall, are estimates significantly different than zero?
t.test(beh_vars$l_grams_ps_lin, mu = 0, alternative = "two.sided") 
t.test(beh_vars$l_kcal_ps_lin, mu = 0, alternative = "two.sided")
t.test(beh_vars$q_grams_ps_quad, mu = 0, alternative = "two.sided")
t.test(beh_vars$q_kcal_ps_quad, mu = 0, alternative = "two.sided")

```

Exploratory correlations between linear and quadratic FEIS slopes, vertices, and CEBQ variables

<!-- ```{r subset based on variables, include=TRUE} -->

<!-- # only include variables that can be interpreted -- this excludes feis intercepts and linear slope from quadratic models (q_*_ps_lin)  -->

<!-- # select behavioral variables for descriptive statistics and correlations -->
<!-- beh_vars <- subset(subset_fmri_covariates, select=c(l_grams_ps_lin, l_kcal_ps_lin, q_grams_ps_quad, q_kcal_ps_quad, g_vertex, kcal_vertex, cebq_fr, cebq_sr)) -->

<!-- # reorder columns  -->
<!-- new_column_order <- c("l_grams_ps_lin",  -->
<!--                       "l_kcal_ps_lin", -->
<!--                       "q_grams_ps_quad", -->
<!--                       "q_kcal_ps_quad", -->
<!--                       "cebq_fr", -->
<!--                       "cebq_sr", -->
<!--                       "g_vertex", -->
<!--                       "kcal_vertex")  -->

<!-- beh_vars <- beh_vars[, new_column_order] # Reorder  -->

<!-- ``` -->

```{r eating behavior associations, include=TRUE}


#### Pearson correlations ####
# create matrix for pearson correlations - exclude vertex due to non-normal distribution
pearson_matrix_vars <- as.matrix(subset_fmri_covariates[, c("l_grams_ps_lin", "l_kcal_ps_lin","q_grams_ps_quad","q_kcal_ps_quad","cebq_fr","cebq_sr")])

# run pearson correlations
pearson_matrix<-rcorr(pearson_matrix_vars, type=c("pearson"))
pearson_r_cormat <- pearson_matrix$r # Matrix of correlation coeficients
pearson_p_cormat <- pearson_matrix$P # Matrix of unadjusted p-values

#### Speaman correlations ####
# create matrix for spearman correlations - include all variables
spearman_matrix_vars <- as.matrix(beh_vars)

# run spearman correlations
spearman_matrix<-rcorr(spearman_matrix_vars, type=c("spearman"))
spearman_r_cormat <- spearman_matrix$r # Matrix of correlation coeficients
spearman_p_cormat <- spearman_matrix$P # Matrix of unadjusted p-values

#### Combine Pearson and Spearman ####

# Create combined matrix
combined_r_cormat <- spearman_r_cormat # make copy of spearman_r_cormat to add to
combined_p_cormat <- spearman_p_cormat # make copy of combined_p_cormat to add to
combined_r_cormat[1:6, 1:6] <- pearson_r_cormat # Replace the upper-left corner of combined_corr matrix with the Pearson correlations
combined_p_cormat[1:6, 1:6] <- pearson_p_cormat # Replace the upper-left corner of combined_corr matrix with the Pearson correlations


# adjust p-values of combined matrix with p.adjust
combined_p_cormat[upper.tri(combined_p_cormat)] <- NA # Isolate half of matrix
combined_p_unadjust_vector <- as.vector(combined_p_cormat) # Transpose matrix to vector
combined_p_adjust_vector <- p.adjust(combined_p_unadjust_vector, method = "BH") # apply BH adjustment to vector (Benjamini & Hochberg (1995) / FDR)

# Define labels
varnames <- c("linear slope, g", 
              "linear slope, kcal", 
              "quadratic slope, g", 
              "quadratic slope, kcal", 
              "food responsiveness",
              "satiety responsiveness",              
              "vertex, g", 
              "vertex, kcal")

# assign variable names
p_ADJ <- matrix(combined_p_adjust_vector,nrow = 8,ncol = 8) # Transpose adjusted vector to matrix
colnames(p_ADJ) <- varnames
rownames(p_ADJ) <- varnames

p_UNADJ <- matrix(combined_p_unadjust_vector,nrow = 8,ncol = 8) # Transpose unadjusted vector to matrix
colnames(p_UNADJ) <- varnames
rownames(p_UNADJ) <- varnames

# Print matrix with rounded r values
combined_r_cormat[upper.tri(combined_r_cormat)] <- NA # Isolate half of matrix
round(combined_r_cormat, 2)

# Print matrix with adjusted p-valyes
round(p_ADJ, 4)

# Print matrix with unadjusted p-valyes
round(p_UNADJ, 4)


```

```{r vertex by quad sign, include=TRUE}

t.test(subset_vertex_no_outliers_g$g_vertex ~ subset_vertex_no_outliers_g$quad_sign_gram, var.equal = FALSE)
t.test(subset_vertex_no_outliers_kcal$kcal_vertex ~ subset_vertex_no_outliers_kcal$quad_sign_kcal, var.equal = FALSE)

```
