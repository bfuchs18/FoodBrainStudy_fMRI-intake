---
title: "descriptive and exploratory analyses"
author: "baf44"
date: "2023-08-02"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Set up

```{r load packages }
# load packages
library(data.table)
library(table1)
library(ggplot2)
library(corrplot)
library(tidyr) # to use "gather()"
library(Hmisc) # to plot all histograms in a dataframe
library(RcmdrMisc)
library(matrixcalc)
library(psych)
```

```{r load generated datasets, include=FALSE}

source("code/gen_fmri_index.R") # this sources setup_data.R, feis_portionsize.R, gen_fmricovtable.R, determine_analysis_sample.R

```

```{r change -999 to NA , include=FALSE}

# Replace all occurrences of -999 with NA
fmri_covariates[fmri_covariates == -999] <- NA

```

## Determine samples

```{r overall sample, include=TRUE}

# combine subset dfs (generated by gen_fmri_index.R) into list
subset_analyses_lists <- list(subset_lin_app_b20, subset_quad_app_b20, subset_fr_app_b20, subset_sr_app_b20, subset_lin_cer_b20, subset_quad_cer_b20, subset_fr_cer_b20, subset_sr_cer_b20)

# Extract the "sub" column from all dataframes and combine into a single vector, get unique values
fmri_subs_included <- unique(unlist(lapply(subset_analyses_lists, function(df) df$sub)))

# count number of subjects included in any fmri analysis
length(fmri_subs_included)

```


```{r by fmri analysis, include=TRUE}

# check number of subjects in subset dataframes (generated by gen_fmri_index.R)
nrow(subset_lin_app_b20)
nrow(subset_quad_app_b20)
nrow(subset_fr_app_b20)
nrow(subset_sr_app_b20)
nrow(subset_lin_cer_b20)
nrow(subset_quad_cer_b20)
nrow(subset_fr_cer_b20)
nrow(subset_sr_cer_b20)
```

Compared to subset_lin_app, subset_quad_app is missing subs "128", "058", "083".
    These subjects do not have FEIS estimates from quadratic models because they are missing intake measurements for 1 meal.

## Subset for analyses

```{r subset based on sample, include=TRUE}

# Subset fmri_covariates based on values in fmri_subs_included
## this is actually redundant, because fmri_covariates only includes subjects who are to be included in fmri analyses
subset_fmri_covariates <- fmri_covariates[fmri_covariates$sub %in% fmri_subs_included, ]

# Subset r01_demo based on values in fmri_subs_included
subset_r01_demo <- r01_demo[r01_demo$sub %in% fmri_subs_included, ]

```

```{r subset based on variables, include=TRUE}

# only include variables that can be interpreted -- this excludes feis intercepts and linear slope from quadratic models (q_*_ps_lin) 

# select behavioral variables for descriptive statistics and correlations
beh_vars <- subset(subset_fmri_covariates, select=c(l_grams_ps_lin, l_kcal_ps_lin, q_grams_ps_quad, q_kcal_ps_quad, g_vertex, kcal_vertex, cebq_fr, cebq_sr))

# reorder columns 
new_column_order <- c("l_grams_ps_lin", 
                      "l_kcal_ps_lin",
                      "q_grams_ps_quad",
                      "q_kcal_ps_quad",
                      "cebq_fr",
                      "cebq_sr",
                      "g_vertex",
                      "kcal_vertex") 

beh_vars <- beh_vars[, new_column_order] # Reorder 

```


## Demographic analyses

```{r table: demographics, include=TRUE}

# assign labels for table1()
label(subset_r01_demo$sex) <- "Sex"
label(subset_r01_demo$race) <- "Race"
label(subset_r01_demo$ethnicity) <- "Ethnicity"
label(subset_r01_demo$age_yr) <- "Age, yrs"
label(subset_r01_demo$income) <- "Family Income"
label(subset_r01_demo$bmi_percentile) <- "BMI percentile"
label(subset_r01_demo$mom_ed) <- "Maternal Education"

# generate table
table1(~ sex + age_yr + race + ethnicity + income + mom_ed+ bmi_percentile , data=subset_r01_demo)

```

## Behavioral analyses

Note: intake_long_analyze was generated by feis_portionsize.R. It only contains subjects who were included in FEIS analyses 

Descriptive statistics for meal variables by portion size 

```{r histogram: meal intake, include=TRUE}

# total grams consumed, overlap by by portion size
ggplot(intake_long_analyze, aes(x=grams, fill = as.factor(PortionSize)))+
   geom_histogram( color='#e9ecef', alpha=1, position='identity')

# total kcal consumed, overlap by portion size
ggplot(intake_long_analyze, aes(x=kcal, fill = as.factor(PortionSize)))+
   geom_histogram( color='#e9ecef', alpha=1, position='identity')

# total grams consumed, facet by portion size
ggplot(intake_long_analyze, aes(grams)) + geom_histogram(bins = 15) + facet_wrap(~PortionSize)

# total kcal consumed, facet by portion size
ggplot(intake_long_analyze, aes(kcal)) + geom_histogram(bins = 15) + facet_wrap(~PortionSize)
```

```{r table: meal intake descriptives, include=TRUE}

# assign labels for table1()
label(intake_long_analyze$grams) <- "Total intake, grams"
label(intake_long_analyze$kcal) <- "Total intake, kcal"
label(intake_long_analyze$preFF) <- "Pre-meal fullness"
label(intake_long_analyze$avg_vas) <- "Average liking"

# generate table
table1(~ grams + kcal + avg_vas + preFF | PortionSize, data=intake_long_analyze, overall=F)

```

Descriptive statistics for linear and quadratic FEIS slopes, verticies, and CEBQ variables

```{r histograms: eating behaviors, include=TRUE}

plot(hist(beh_vars$l_grams_ps_lin), main = "Linear PSE (grams)", cex.main = 2, cex.lab = 1.2)
plot(hist(beh_vars$l_kcal_ps_lin), main = "Linear PSE (kcal)", cex.main = 2, cex.lab = 1.2)
plot(hist(beh_vars$q_grams_ps_quad), main = "Quadratic PSE (grams)", cex.main = 2, cex.lab = 1.2)
plot(hist(beh_vars$q_kcal_ps_quad), main = "Quadratic PSE (kcal)", cex.main = 2, cex.lab = 1.2)
plot(hist(beh_vars$g_vertex), main = "Vertex (grams)", cex.main = 2, cex.lab = 1.2) # do analyses with and without outlier?
plot(hist(beh_vars$kcal_vertex), main = "Vertex (kcal)", cex.main = 2, cex.lab = 1.2) # do analyses with and without outlier?
plot(hist(beh_vars$cebq_fr), main = "Food responsiveness", cex.main = 2, cex.lab = 1.2) 
plot(hist(beh_vars$cebq_sr), main = "Satiety responsiveness", cex.main = 2, cex.lab = 1.2)

hist(beh_vars$kcal_vertex, breaks = 100) # visualize histograms with more breaks
hist(beh_vars$g_vertex, breaks = 100) # visualize histograms with more breaks

# test normality using Kolmogorov Smirnov -- p < 0.05 indicates significant difference from normal distribution
ks.test(beh_vars$l_grams_ps_lin, "pnorm", mean=mean(beh_vars$l_grams_ps_lin, na.rm = TRUE), sd=sd(beh_vars$l_grams_ps_lin, na.rm = TRUE))
ks.test(beh_vars$l_kcal_ps_lin, "pnorm", mean=mean(beh_vars$l_kcal_ps_lin, na.rm = TRUE), sd=sd(beh_vars$l_kcal_ps_lin, na.rm = TRUE))
ks.test(beh_vars$q_grams_ps_quad, "pnorm", mean=mean(beh_vars$q_grams_ps_quad, na.rm = TRUE), sd=sd(beh_vars$q_grams_ps_quad, na.rm = TRUE))
ks.test(beh_vars$q_kcal_ps_quad, "pnorm", mean=mean(beh_vars$q_kcal_ps_quad, na.rm = TRUE), sd=sd(beh_vars$q_kcal_ps_quad, na.rm = TRUE))
ks.test(beh_vars$g_vertex, "pnorm", mean=mean(beh_vars$g_vertex, na.rm = TRUE), sd=sd(beh_vars$g_vertex, na.rm = TRUE))
ks.test(beh_vars$kcal_vertex, "pnorm", mean=mean(beh_vars$kcal_vertex, na.rm = TRUE), sd=sd(beh_vars$kcal_vertex, na.rm = TRUE))
ks.test(beh_vars$cebq_fr, "pnorm", mean=mean(beh_vars$cebq_fr, na.rm = TRUE), sd=sd(beh_vars$cebq_fr, na.rm = TRUE))
ks.test(beh_vars$cebq_sr, "pnorm", mean=mean(beh_vars$cebq_sr, na.rm = TRUE), sd=sd(beh_vars$cebq_sr, na.rm = TRUE))


```

```{r examine vertex outliers, include=TRUE}

boxplot(beh_vars$g_vertex)
boxplot(beh_vars$kcal_vertex)

## use N outliers for Rosner outlier detection 
qqnorm(beh_vars$g_vertex, pch = 1, frame = FALSE) #4 outliners (>1 sample quantile)
qqline(beh_vars$g_vertex)

qqnorm(beh_vars$kcal_vertex, pch = 1, frame = FALSE) #3 outliers 
qqline(beh_vars$kcal_vertex)

# kNN imputation using all the data that went into FEIS and slopes?
# https://datascienceplus.com/missing-value-treatment/
```

```{r 1 sample T: eating behavior descriptives, include=TRUE}

# overall, are estimates significantly different than zero?
t.test(beh_vars$l_grams_ps_lin, mu = 0, alternative = "two.sided")
t.test(beh_vars$l_kcal_ps_lin, mu = 0, alternative = "two.sided")
t.test(beh_vars$q_grams_ps_quad, mu = 0, alternative = "two.sided")
t.test(beh_vars$q_kcal_ps_quad, mu = 0, alternative = "two.sided")

# Count the number of quadratic estimates greater than 0
lin_g_count_above_zero <- sum(beh_vars$l_grams_ps_lin > 0, na.rm = TRUE)
lin_kcal_count_above_zero <- sum(beh_vars$l_kcal_ps_lin > 0, na.rm = TRUE)
quad_g_count_above_zero <- sum(beh_vars$q_grams_ps_quad > 0, na.rm = TRUE)
quad_kcal_count_above_zero <- sum(beh_vars$q_kcal_ps_quad > 0, na.rm = TRUE)

# Calculate the percentage above 0
lin_g_percentage_above_zero <- (lin_g_count_above_zero / sum(!is.na(beh_vars$l_grams_ps_lin))) * 100
lin_kcal_percentage_above_zero <- (lin_kcal_count_above_zero / sum(!is.na(beh_vars$l_kcal_ps_lin))) * 100
quad_g_percentage_above_zero <- (quad_g_count_above_zero / sum(!is.na(beh_vars$q_grams_ps_quad))) * 100
quad_kcal_percentage_above_zero <- (quad_kcal_count_above_zero / sum(!is.na(beh_vars$q_kcal_ps_quad))) * 100

```

```{r table: eating behavior descriptives, include=TRUE}

# assign labels for table1()
label(beh_vars$l_grams_ps_lin) <- "linear slope, g"
label(beh_vars$l_kcal_ps_lin) <- "linear slope, kcal"
label(beh_vars$q_grams_ps_quad) <- "quadratic slope, g"
label(beh_vars$q_kcal_ps_quad) <- "quadratic slope, kcal"
label(beh_vars$g_vertex) <- "vertex, g"
label(beh_vars$kcal_vertex) <- "vertex, kcal"
label(beh_vars$cebq_fr) <- "food responsiveness"
label(beh_vars$cebq_sr) <- "satiety responsiveness"

# generate table
table1(~ l_grams_ps_lin + l_kcal_ps_lin + q_grams_ps_quad + q_kcal_ps_quad + 
         g_vertex + kcal_vertex + cebq_fr + cebq_sr, data=beh_vars)

```

Exploratory correlations between linear and quadratic FEIS slopes, vertices, and CEBQ variables

```{r eating behavior associations, include=TRUE}


#### Pearson correlations ####
# create matrix for pearson correlations - exclude vertex due to non-normal distribution
pearson_matrix_vars <- as.matrix(beh_vars[, c("l_grams_ps_lin", "l_kcal_ps_lin","q_grams_ps_quad","q_kcal_ps_quad","cebq_fr","cebq_sr")])

# run pearson correlations
pearson_matrix<-rcorr(pearson_matrix_vars, type=c("pearson"))
pearson_r_cormat <- pearson_matrix$r # Matrix of correlation coeficients
pearson_p_cormat <- pearson_matrix$P # Matrix of unadjusted p-values

#### Speaman correlations ####
# create matrix for spearman correlations - include all variables
spearman_matrix_vars <- as.matrix(beh_vars)

# run spearman correlations
spearman_matrix<-rcorr(spearman_matrix_vars, type=c("spearman"))
spearman_r_cormat <- spearman_matrix$r # Matrix of correlation coeficients
spearman_p_cormat <- spearman_matrix$P # Matrix of unadjusted p-values

#### Combine Pearson and Spearman ####

# Create combined matrix
combined_r_cormat <- spearman_r_cormat # make copy of spearman_r_cormat to add to
combined_p_cormat <- spearman_p_cormat # make copy of combined_p_cormat to add to
combined_r_cormat[1:6, 1:6] <- pearson_r_cormat # Replace the upper-left corner of combined_corr matrix with the Pearson correlations
combined_p_cormat[1:6, 1:6] <- pearson_p_cormat # Replace the upper-left corner of combined_corr matrix with the Pearson correlations


# adjust p-values of combined matrix with p.adjust
combined_p_cormat[upper.tri(combined_p_cormat)] <- NA # Isolate half of matrix
combined_p_unadjust_vector <- as.vector(combined_p_cormat) # Transpose matrix to vector
combined_p_adjust_vector <- p.adjust(combined_p_unadjust_vector, method = "BH") # apply BH adjustment to vector (Benjamini & Hochberg (1995) / FDR)

# Define labels
varnames <- c("linear slope, g", 
              "linear slope, kcal", 
              "quadratic slope, g", 
              "quadratic slope, kcal", 
              "food responsiveness",
              "satiety responsiveness",              
              "vertex, g", 
              "vertex, kcal")

# assign variable names
p_ADJ <- matrix(combined_p_adjust_vector,nrow = 8,ncol = 8) # Transpose adjusted vector to matrix
colnames(p_ADJ) <- varnames
rownames(p_ADJ) <- varnames

p_UNADJ <- matrix(combined_p_unadjust_vector,nrow = 8,ncol = 8) # Transpose unadjusted vector to matrix
colnames(p_UNADJ) <- varnames
rownames(p_UNADJ) <- varnames

# Print matrix with rounded r values
combined_r_cormat[upper.tri(combined_r_cormat)] <- NA # Isolate half of matrix
round(combined_r_cormat, 2)

# Print matrix with adjusted p-valyes
round(p_ADJ, 4)

# Print matrix with unadjusted p-valyes
round(p_UNADJ, 4)


```

