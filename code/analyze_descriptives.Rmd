---
title: "descriptive statistics"
author: "baf44"
date: "2023-08-02"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Set up

```{r load packages }
# load packages
library(data.table)
library(table1)
library(ggplot2)
library(corrplot)
library(tidyr) # to use "gather()"
library(Hmisc) # to plot all histograms in a dataframe
library(RcmdrMisc)
library(matrixcalc)
library(psych)
```

```{r load generated datasets, include=FALSE}

source("code/gen_fmri_index.R") # this sources setup_data.R, feis_portionsize.R, gen_fmri_covtable.R, determine_analysis_sample.R

```

```{r change -999 to NA , include=FALSE}

# Replace all occurrences of -999 with NA
fmri_covariates[fmri_covariates == -999] <- NA

```

## Determine samples

```{r participant sample, include=TRUE}

# count number of children who attended V6
nrow(r01_V6)

```

```{r analysis sample, include=TRUE}

# combine subset dfs (generated by gen_fmri_index.R) into list
subset_analyses_lists <- list(subset_lin_app_b20, subset_quad_app_b20, subset_lin_cer_b20, subset_quad_cer_b20)

# Extract the "sub" column from all dataframes and combine into a single vector, get unique values
fmri_subs_included <- unique(unlist(lapply(subset_analyses_lists, function(df) df$sub)))

# count number of subjects included in any fmri analysis
length(fmri_subs_included)

```

```{r sample size by fmri analysis, include=TRUE}

# check number of subjects in subset dataframes (generated by gen_fmri_index.R)

nrow(subset_lin_app_b20) # analyses w/ linear slopes, appetitive network mask
nrow(subset_quad_app_b20) # analyses w/ quadtratic slopes, appetitive network mask
nrow(subset_lin_cer_b20) # analyses w/ linear slopes, cerebellum mask
nrow(subset_quad_cer_b20) # analyses w/ quadtratic slopes, cerebellum mask


```

Compared to subset_lin_app, subset_quad_app is missing subs "128", "058", "083". -- These subjects do not have FEIS estimates from quadratic models because they are missing intake measurements for 1 meal.

## Prep for analyses

```{r prep participants_r01_demo, include=TRUE}

# Subset r01_demo based on values (subject IDs) in fmri_subs_included
subset_r01_demo <- r01_demo[r01_demo$sub %in% fmri_subs_included, ]
participants_r01_demo <- r01_demo[r01_demo$sub %in% r01_V6$sub, ]

# add analyzed column- 1: sub included in analyses, 0: sub not included
participants_r01_demo$analyzed <- ifelse(participants_r01_demo$sub %in% fmri_subs_included, 1, 0)

# Add variables used as MRI covariates to participants_r01_demo
participants_r01_demo <- merge(participants_r01_demo, fd[, c("sub", "fd_avg_allruns")], by = "sub", all.x = TRUE)
participants_r01_demo <- merge(participants_r01_demo, impute_data[, c("sub", "pre_mri_ff")], by = "sub", all.x = TRUE) #impute_data is generated in gen_fmri_covtable. It includes all subs who attended V6, and does not contain the imputed pre-mri fullness value
participants_r01_demo <- merge(participants_r01_demo, r01_V6[, c("sub", "cams_pre_mri")], by = "sub", all.x = TRUE)

```


## Manuscript Table 2 - Participant characteristics

```{r assess distributions of imaging covariates, include=TRUE}

## assess distributions
hist(participants_r01_demo$pre_mri_ff)
hist(participants_r01_demo$cams_pre_mri)
hist(participants_r01_demo$fd_avg_allruns)
ks.test(participants_r01_demo$pre_mri_ff, "pnorm", mean=mean(fmri_covariates$pre_mri_ff, na.rm = TRUE), sd=sd(fmri_covariates$pre_mri_ff, na.rm = TRUE))
ks.test(participants_r01_demo$cams_pre_mri, "pnorm", mean=mean(fmri_covariates$cams_pre_mri, na.rm = TRUE), sd=sd(fmri_covariates$cams_pre_mri, na.rm = TRUE))
ks.test(participants_r01_demo$fd_avg_allruns, "pnorm", mean=mean(fmri_covariates$fd_avg_allruns, na.rm = TRUE), sd=sd(fmri_covariates$fd_avg_allruns, na.rm = TRUE))

```

Participant table includes descriptive statistics for demographic and imaging covariates, by inclusion status
```{r make participant table, include=TRUE}

# make mom_edu variable with 3 levels -- combine technical degree + high school into < Bachelor
participants_r01_demo$mom_ed_3categories <- participants_r01_demo$mom_ed
participants_r01_demo$mom_ed_3categories[participants_r01_demo$mom_ed_3categories == "AA/Technical Degree"] <- "< Bachelor Degree"
participants_r01_demo$mom_ed_3categories[participants_r01_demo$mom_ed_3categories == "High School/GED"] <- "< Bachelor Degree"

# prepare variables
participants_r01_demo$analyzed <- factor(participants_r01_demo$analyzed, levels=c(1,0),
         labels=c("Included", 
                  "Excluded"))

# reorder levels
participants_r01_demo$mom_ed_3categories <- factor(participants_r01_demo$mom_ed_3categories, levels=c("< Bachelor Degree", "Bachelor Degree", "> Bachelor Degree"))
participants_r01_demo$income <- factor(participants_r01_demo$income, levels=c("< $51,000", "$51,000 - $100,000", ">$100,000"))


# assign labels for table1()
label(participants_r01_demo$sex) <- "Sex"
label(participants_r01_demo$race) <- "Race"
label(participants_r01_demo$ethnicity) <- "Ethnicity"
label(participants_r01_demo$age_yr) <- "Age, yrs"
label(participants_r01_demo$income) <- "Family Income"
label(participants_r01_demo$bmi_percentile) <- "BMI percentile"
label(participants_r01_demo$mom_ed_3categories) <- "Maternal Education"
label(participants_r01_demo$cams_pre_mri) <- "pre-MRI anxiety"
label(participants_r01_demo$pre_mri_ff) <- "pre-MRI fullness"
label(participants_r01_demo$fd_avg_allruns) <- "Average framewise displacement"

# generate table
table1(~ sex + age_yr + race + ethnicity + income + mom_ed_3categories+ bmi_percentile + pre_mri_ff + cams_pre_mri + fd_avg_allruns| analyzed, data=participants_r01_demo, overall = F)

# get quartiles for pre-MRI anxiety and FD by group (variables are non-normally distributed)
tapply(participants_r01_demo$cams_pre_mri, participants_r01_demo$analyzed, summary)
tapply(participants_r01_demo$fd_avg_allruns, participants_r01_demo$analyzed, summary)

```


```{r comparisons by inclusion status, include=TRUE}

# sex
chisq.test(participants_r01_demo$analyzed, participants_r01_demo$sex, correct=TRUE)

# age
t.test(participants_r01_demo$age_yr ~ participants_r01_demo$analyzed, var.equal = FALSE)

# race
fisher.test(participants_r01_demo$analyzed, participants_r01_demo$race)

# income
fisher.test(participants_r01_demo$analyzed, participants_r01_demo$income)

# maternal education
chisq.test(participants_r01_demo$analyzed, participants_r01_demo$mom_ed_3categories, correct=TRUE)

# BMI %tile
t.test(participants_r01_demo$bmi_percentile ~ participants_r01_demo$analyzed, var.equal = FALSE)

# pre-mri anxiety
t.test(participants_r01_demo$cams_pre_mri ~ participants_r01_demo$analyzed, var.equal = FALSE)
wilcox.test(cams_pre_mri ~ analyzed,
                   data = participants_r01_demo,
                   exact = FALSE)

# FD
t.test(participants_r01_demo$fd_avg_allruns ~ participants_r01_demo$analyzed, var.equal = FALSE)
wilcox.test(fd_avg_allruns ~ analyzed,
                   data = participants_r01_demo,
                   exact = FALSE)

# pre-mri fullness
t.test(participants_r01_demo$pre_mri_ff ~ participants_r01_demo$analyzed, var.equal = FALSE)


```


## Manuscript Table 3 - Descriptives for portion size slopes

Portion size slopes are estimated from feis_portionsize.R

```{r generate table, include=TRUE}

# subset_fmri_covariates

# assign labels for table1()
label(fmri_covariates$l_grams_ps_lin) <- "linear portion size slope, g"
label(fmri_covariates$l_kcal_ps_lin) <- "linear portion size slope, kcal"
label(fmri_covariates$q_grams_ps_quad) <- "quadratic portion size slope, g"
label(fmri_covariates$q_kcal_ps_quad) <- "quadratic portion size slope, kcal"

# generate table
table1(~ l_grams_ps_lin + l_kcal_ps_lin + q_grams_ps_quad + q_kcal_ps_quad, data=fmri_covariates)

```

```{r assess variability in linear slope, include=TRUE}

count_positive_lin_g <- sum(fmri_covariates$l_grams_ps_lin > 0)
count_positive_lin_kcal <- sum(fmri_covariates$l_kcal_ps_lin > 0)

percent_positive_lin_g <- (count_positive_lin_g / nrow(fmri_covariates)) * 100
percent_positive_lin_kcal <- (count_positive_lin_kcal / nrow(fmri_covariates)) * 100

percent_positive_lin_g # percent of children with positive linear slope (grams)
percent_positive_lin_kcal # percent of children with positive linear slope (kcal)
```

```{r characterization of quadratic slopes, include=TRUE}

subset_quad_analyses$q_grams_lin_sign <- ifelse(subset_quad_analyses$q_grams_ps_lin >0, "pos lin q slope", ifelse(subset_quad_analyses$q_grams_ps_lin < 0, "neg lin q slope", ""))

subset_quad_analyses$q_kcal_lin_sign <- ifelse(subset_quad_analyses$q_kcal_ps_lin >0, "pos lin q slope", ifelse(subset_quad_analyses$q_kcal_ps_lin < 0, "neg lin q slope", ""))


table1(~ q_grams_lin_sign | quad_sign_gram , data=subset_quad_analyses)
table1(~ q_kcal_lin_sign | quad_sign_kcal , data=subset_quad_analyses)

```


# Manuscript Table S3 - Correlations between portion size slopes

```{r correlation matrix, include=TRUE}

#### Pearson correlations ####
# create matrix for pearson correlations - exclude vertex due to non-normal distribution
pearson_matrix_vars <- as.matrix(fmri_covariates[, c("l_grams_ps_lin", "l_kcal_ps_lin","q_grams_ps_quad","q_kcal_ps_quad")])

# run pearson correlations
pearson_matrix<-rcorr(pearson_matrix_vars, type=c("pearson"))
pearson_r_cormat <- pearson_matrix$r # Matrix of correlation coeficients
pearson_p_cormat <- pearson_matrix$P # Matrix of unadjusted p-values

#### Combine Pearson and Spearman ####

# # Create combined matrix
# combined_r_cormat <- spearman_r_cormat # make copy of spearman_r_cormat to add to
# combined_p_cormat <- spearman_p_cormat # make copy of combined_p_cormat to add to
# combined_r_cormat[1:6, 1:6] <- pearson_r_cormat # Replace the upper-left corner of combined_corr matrix with the Pearson correlations
# combined_p_cormat[1:6, 1:6] <- pearson_p_cormat # Replace the upper-left corner of combined_corr matrix with the Pearson correlations


# adjust p-values of combined matrix with p.adjust
pearson_p_cormat[upper.tri(pearson_p_cormat)] <- NA # Isolate half of matrix
p_unadjust_vector <- as.vector(pearson_p_cormat) # Transpose matrix to vector
p_adjust_vector <- p.adjust(p_unadjust_vector, method = "BH") # apply BH adjustment to vector (Benjamini & Hochberg (1995) / FDR)

# Define labels
varnames <- c("linear slope, g", 
              "linear slope, kcal", 
              "quadratic slope, g", 
              "quadratic slope, kcal")

# assign variable names
p_ADJ <- matrix(p_adjust_vector,nrow = 4,ncol = 4) # Transpose adjusted vector to matrix
colnames(p_ADJ) <- varnames
rownames(p_ADJ) <- varnames

p_UNADJ <- matrix(p_unadjust_vector,nrow = 4,ncol = 4) # Transpose unadjusted vector to matrix
colnames(p_UNADJ) <- varnames
rownames(p_UNADJ) <- varnames

# Print matrix with rounded r values
pearson_r_cormat[upper.tri(pearson_r_cormat)] <- NA # Isolate half of matrix
round(pearson_r_cormat, 2)

# Print matrix with adjusted p-valyes
round(p_ADJ, 4)

# Print matrix with unadjusted p-valyes
round(p_UNADJ, 4)

```
