---
title: "roi_analyses"
author: "baf44"
date: "3/15/2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

#### setup

```{r load functions and data, include=FALSE}
library(feisr)
library(lme4)
library(lmerTest)
library(stringr)
library(dplyr)
library(tidyverse)
library(sjPlot)

# set project directory
#source("code/setup_data.R")
source("code/gen_fmri_covtable.R") # this will source setup_data

# import betas extract from ROIs
LargevSmall_betas <- read.delim("~/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/a-bari/00_PennState/Projects/FoodBrainStudy_fMRI-intake/BIDS/derivatives/analyses/foodcue-paper2/keller2019_rois/all_betas-Large-Small_allED.txt")

hED_LargevSmall_betas <- read.delim("~/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/a-bari/00_PennState/Projects/FoodBrainStudy_fMRI-intake/BIDS/derivatives/analyses/foodcue-paper2/keller2019_rois/all_betas-HighLarge-Small.txt")

lED_LargevSmall_betas <- read.delim("~/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/a-bari/00_PennState/Projects/FoodBrainStudy_fMRI-intake/BIDS/derivatives/analyses/foodcue-paper2/keller2019_rois/all_betas-LowLarge-Small.txt")

```

```{r clean beta dataframes, include=FALSE}

# remove rows without data
LargevSmall_betas_clean<-LargevSmall_betas[!(LargevSmall_betas$File=="File"),]
hED_LargevSmall_betas<-hED_LargevSmall_betas[!(hED_LargevSmall_betas$File=="File"),]
lED_LargevSmall_betas<-lED_LargevSmall_betas[!(lED_LargevSmall_betas$File=="File"),]

# make subject column that extracts sub-XXX
LargevSmall_betas_clean$sub <- sapply(str_split(LargevSmall_betas_clean$File, "/"), `[`, 12)
hED_LargevSmall_betas$sub <- sapply(str_split(hED_LargevSmall_betas$File, "/"), `[`, 12)
lED_LargevSmall_betas$sub <- sapply(str_split(lED_LargevSmall_betas$File, "/"), `[`, 12)

# remove "sub-" from "sub-XXX" to isolate ID
LargevSmall_betas_clean$sub <- as.numeric(sub("sub-", "", LargevSmall_betas_clean$sub))
hED_LargevSmall_betas$sub <- as.numeric(sub("sub-", "", hED_LargevSmall_betas$sub))
lED_LargevSmall_betas$sub <- as.numeric(sub("sub-", "", lED_LargevSmall_betas$sub))

# remove File and Sub.brick columns
LargevSmall_betas_clean = subset(LargevSmall_betas_clean, select = -c(File, Sub.brick))
hED_LargevSmall_betas = subset(hED_LargevSmall_betas, select = -c(File, Sub.brick))
lED_LargevSmall_betas = subset(lED_LargevSmall_betas, select = -c(File, Sub.brick))

# change column names
# Define a mapping of old names to new names
name_mapping <- c("Mean_1" = "r_amygdala", 
                  "Mean_2" = "l_amygdala",
                  "Mean_4" = "r_striatum",
                  "Mean_8" = "l_striatum",
                  "Mean_16" = "r_ofc2",
                  "Mean_32" = "l_ofc2",
                  "Mean_64" = "r_vmpfc1",
                  "Mean_128" = "l_vmpfc1",
                  "Mean_256" = "r_vmpfc2",
                  "Mean_512" = "l_vmpfc2",
                  "Mean_1024" = "r_ifg",
                  "Mean_2048" = "l_ifg",
                  "Mean_4096" = "r_dlpfc",
                  "Mean_8192" = "l_dlpfc",
                  "Mean_16384" = "r_caudate",
                  "Mean_32767" = "l_caudate")

# Update the column names using the mapping
colnames(LargevSmall_betas_clean) <- sapply(colnames(LargevSmall_betas_clean), function(x) ifelse(x %in% names(name_mapping), name_mapping[x], x))
colnames(hED_LargevSmall_betas) <- sapply(colnames(hED_LargevSmall_betas), function(x) ifelse(x %in% names(name_mapping), name_mapping[x], x))
colnames(lED_LargevSmall_betas) <- sapply(colnames(lED_LargevSmall_betas), function(x) ifelse(x %in% names(name_mapping), name_mapping[x], x))

```

```{r concat intake and brain data, include=FALSE}

# pad sub with zeros
LargevSmall_betas_clean$sub <- sprintf("%03d", LargevSmall_betas_clean$sub)
hED_LargevSmall_betas$sub <- sprintf("%03d", hED_LargevSmall_betas$sub)
lED_LargevSmall_betas$sub <- sprintf("%03d", lED_LargevSmall_betas$sub)

# left join -- only retain subjects who have brain data
intake_long_LargevSmall <- left_join(LargevSmall_betas_clean, intake_long, by="sub", multiple = "all")
intake_long_LargevSmall <- left_join(intake_long_LargevSmall, fmri_covariates, by="sub", multiple = "all")

hED_intake_long_LargevSmall <- left_join(hED_LargevSmall_betas, intake_long, by="sub", multiple = "all")
hED_intake_long_LargevSmall <- left_join(hED_intake_long_LargevSmall, fmri_covariates, by="sub", multiple = "all")

lED_intake_long_LargevSmall <- left_join(lED_LargevSmall_betas, intake_long, by="sub", multiple = "all")
lED_intake_long_LargevSmall <- left_join(lED_intake_long_LargevSmall, fmri_covariates, by="sub", multiple = "all")


# convert roi columns (1:16) to numeric
intake_long_LargevSmall <- intake_long_LargevSmall %>% mutate_at(vars(1:16), as.numeric)
hED_intake_long_LargevSmall <- hED_intake_long_LargevSmall %>% mutate_at(vars(1:16), as.numeric)
lED_intake_long_LargevSmall <- lED_intake_long_LargevSmall %>% mutate_at(vars(1:16), as.numeric)
```


#### mixed effects analyses #### 

Keller et al. 2019 methods: "Related covariates, including sex, age, weight status (BMI z-score), average rated liking of the test-meal items, motion parameters for the fMRI (average motion in the x, y, and z planes concatenated across all runs), and fullness (computed as an average pre-meal fullness rating across the 4 meals), were entered independently into models as fixed factors, and removed if they were not significant. Signal-to-noise ratio (SNR) and TSNR from the fMRI scan were also included to determine if they influenced the relationship between brain response and the PSE. All interactions between covariates and PS condition were tested simultaneously and removed from the final model if not significant"

Differences from Keller et al. 2019 methods -- replaced sex, age, weight status with ree (calculated based on age, sex, height, and weight)
```{r BOLD vs intake - across ED, include=TRUE}

## run each model with BOLD*linear term, BOLD*quadratic term, covariates
model_r_amygdala <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_amygdala + I(ps_prop*ps_prop)*r_amygdala + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_amygdala <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_amygdala + I(ps_prop*ps_prop)*l_amygdala + ree + (1 | sub), data = intake_long_LargevSmall)
model_r_striatum <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_striatum + I(ps_prop*ps_prop)*r_striatum + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_striatum <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_striatum + I(ps_prop*ps_prop)*l_striatum + ree + (1 | sub), data = intake_long_LargevSmall)
model_r_ofc2 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_ofc2 + I(ps_prop*ps_prop)*r_ofc2 + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_ofc2 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_ofc2 + I(ps_prop*ps_prop)*l_ofc2 + ree + (1 | sub), data = intake_long_LargevSmall)
model_r_vmpfc1 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc1 + I(ps_prop*ps_prop)*r_vmpfc1 + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_vmpfc1 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc1 + I(ps_prop*ps_prop)*l_vmpfc1 + ree + (1 | sub), data = intake_long_LargevSmall)
model_r_vmpfc2 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc2 + I(ps_prop*ps_prop)*r_vmpfc2 + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_vmpfc2 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc2 + I(ps_prop*ps_prop)*l_vmpfc2 + ree + (1 | sub), data = intake_long_LargevSmall)
model_r_ifg <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_ifg + I(ps_prop*ps_prop)*r_ifg + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_ifg <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_ifg + I(ps_prop*ps_prop)*l_ifg + ree + (1 | sub), data = intake_long_LargevSmall)
model_r_dlpfc <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_dlpfc + I(ps_prop*ps_prop)*r_dlpfc + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_dlpfc <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_dlpfc + I(ps_prop*ps_prop)*l_dlpfc + ree + (1 | sub), data = intake_long_LargevSmall)
model_r_caudate <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_caudate + I(ps_prop*ps_prop)*r_caudate + ree + (1 | sub), data = intake_long_LargevSmall)
model_l_caudate <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_caudate + I(ps_prop*ps_prop)*l_caudate + ree + (1 | sub), data = intake_long_LargevSmall)


# summaries -- determine inclusion of quadratic term
summary(model_r_amygdala) # quadratic
summary(model_l_amygdala)
summary(model_r_striatum) 
summary(model_l_striatum) 
summary(model_r_ofc2) # lin and quadratic
summary(model_l_ofc2) # lin and quadratic
summary(model_r_vmpfc1)
summary(model_l_vmpfc1)
summary(model_r_vmpfc2) # lin and quadratic
summary(model_l_vmpfc2) # quadratic
summary(model_r_ifg)
summary(model_l_ifg)
summary(model_r_dlpfc)
summary(model_l_dlpfc)
summary(model_r_caudate)
summary(model_l_caudate)


# For ROIs where quadtratic terms are not significant, remove them for parsimony
lin_model_l_amygdala <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_amygdala + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_r_striatum <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_striatum + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_l_striatum <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_striatum + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_r_vmpfc1 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc1 + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_l_vmpfc1 <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc1 + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_r_ifg <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_ifg + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_l_ifg <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_ifg + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_r_dlpfc <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_dlpfc + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_l_dlpfc <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_dlpfc + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_r_caudate <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*r_caudate + ree + (1 | sub), data = intake_long_LargevSmall)
lin_model_l_caudate <- lmer(grams ~ preFF + avg_vas + meal_order + ps_prop*l_caudate + ree + (1 | sub), data = intake_long_LargevSmall)

# summaries
summary(lin_model_l_amygdala)
summary(lin_model_r_striatum)
summary(lin_model_l_striatum) #lin
summary(lin_model_r_vmpfc1) #lin
summary(lin_model_l_vmpfc1)
summary(lin_model_r_ifg)
summary(lin_model_l_ifg)
summary(lin_model_r_dlpfc)
summary(lin_model_l_dlpfc) 
summary(lin_model_r_caudate) # lin
summary(lin_model_l_caudate)
```

Interpretation of negative quadratic*BOLD for OFC and VMPFC:
As BOLD response to large-small increased, there was a more negative quadratic association between proportion and intake (greater decelleration in intake as portions increased)

Results from Keller et al. 2019: For the vmPFC, high activation to Large relative to Small PS was positively associated with the linear slope (i.e., the increase in intake from baseline, 0.32; P≤ 0.05) and a negative influence on the quadratic coefficient (i.e., the deceleration in intake as portion sizes become larger, −0.0006; P< 0.05) compared to children with low activation in this region. A similar pattern of results was also seen for the OFC, as high activation to Large relative to Small PS was positively associated with the linear slope (0.14; P< 0.005) but negatively with the quadratic deceleration (−0.047; P< 0.01).



```{r BOLD vs intake - high ED, include=TRUE}

## run each model with BOLD*linear term, BOLD*quadratic term, covariates
hed_model_r_amygdala <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_amygdala + I(ps_prop*ps_prop)*r_amygdala + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_amygdala <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_amygdala + I(ps_prop*ps_prop)*l_amygdala + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_r_striatum <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_striatum + I(ps_prop*ps_prop)*r_striatum + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_striatum <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_striatum + I(ps_prop*ps_prop)*l_striatum + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_r_ofc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_ofc2 + I(ps_prop*ps_prop)*r_ofc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_ofc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ofc2 + I(ps_prop*ps_prop)*l_ofc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_r_vmpfc1 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc1 + I(ps_prop*ps_prop)*r_vmpfc1 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_vmpfc1 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc1 + I(ps_prop*ps_prop)*l_vmpfc1 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_r_vmpfc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc2 + I(ps_prop*ps_prop)*r_vmpfc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_vmpfc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc2 + I(ps_prop*ps_prop)*l_vmpfc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_r_ifg <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_ifg + I(ps_prop*ps_prop)*r_ifg + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_ifg <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ifg + I(ps_prop*ps_prop)*l_ifg + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_r_dlpfc <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_dlpfc + I(ps_prop*ps_prop)*r_dlpfc + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_dlpfc <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_dlpfc + I(ps_prop*ps_prop)*l_dlpfc + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_r_caudate <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_caudate + I(ps_prop*ps_prop)*r_caudate + ree + (1 | sub), data = hED_intake_long_LargevSmall)
hed_model_l_caudate <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_caudate + I(ps_prop*ps_prop)*l_caudate + ree + (1 | sub), data = hED_intake_long_LargevSmall)


# summaries -- determine inclusion of quadratic term
summary(hed_model_r_amygdala)
summary(hed_model_l_amygdala) #quad
summary(hed_model_r_striatum) # warning Some predictor variables are on very different scales: consider rescaling
summary(hed_model_l_striatum) 
summary(hed_model_r_ofc2)
summary(hed_model_l_ofc2)
summary(hed_model_r_vmpfc1)
summary(hed_model_l_vmpfc1)
summary(hed_model_r_vmpfc2) 
summary(hed_model_l_vmpfc2)
summary(hed_model_r_ifg)
summary(hed_model_l_ifg)
summary(hed_model_r_dlpfc)
summary(hed_model_l_dlpfc)
summary(hed_model_r_caudate)
summary(hed_model_l_caudate)


# For ROIs where quadtratic terms are not significant, remove them for parsimony
lin_hed_model_r_amygdala <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_amygdala + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_r_striatum <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_striatum + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_l_striatum <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_striatum + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_r_ofc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_ofc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_l_ofc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ofc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_r_vmpfc1 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc1 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_l_vmpfc1 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc1 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_r_vmpfc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_l_vmpfc2 <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc2 + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_r_ifg <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_ifg + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_l_ifg <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ifg + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_r_dlpfc <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_dlpfc + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_l_dlpfc <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_dlpfc + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_r_caudate <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*r_caudate + ree + (1 | sub), data = hED_intake_long_LargevSmall)
lin_hed_model_l_caudate <- lmer(hed_grams ~ preFF + avg_vas + meal_order + ps_prop*l_caudate + ree + (1 | sub), data = hED_intake_long_LargevSmall)


# summaries
summary(lin_hed_model_r_amygdala)
summary(lin_hed_model_r_striatum)
summary(lin_hed_model_l_striatum) # warning Some predictor variables are on very different scales: consider rescaling
summary(lin_hed_model_r_ofc2) 
summary(lin_hed_model_l_ofc2)
summary(lin_hed_model_r_vmpfc1)
summary(lin_hed_model_l_vmpfc1)
summary(lin_hed_model_r_vmpfc2) 
summary(lin_hed_model_l_vmpfc2)
summary(lin_hed_model_r_ifg)
summary(lin_hed_model_l_ifg)
summary(lin_hed_model_r_dlpfc)
summary(lin_hed_model_l_dlpfc)
summary(lin_hed_model_r_caudate)
summary(lin_hed_model_l_caudate)
```


```{r BOLD vs intake - low ED, include=TRUE}

## run each model with BOLD*linear term, BOLD*quadratic term, covariates
led_model_r_amygdala <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_amygdala + I(ps_prop*ps_prop)*r_amygdala + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_amygdala <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_amygdala + I(ps_prop*ps_prop)*l_amygdala + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_r_striatum <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_striatum + I(ps_prop*ps_prop)*r_striatum + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_striatum <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_striatum + I(ps_prop*ps_prop)*l_striatum + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_r_ofc2 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_ofc2 + I(ps_prop*ps_prop)*r_ofc2 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_ofc2 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ofc2 + I(ps_prop*ps_prop)*l_ofc2 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_r_vmpfc1 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc1 + I(ps_prop*ps_prop)*r_vmpfc1 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_vmpfc1 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc1 + I(ps_prop*ps_prop)*l_vmpfc1 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_r_vmpfc2 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc2 + I(ps_prop*ps_prop)*r_vmpfc2 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_vmpfc2 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc2 + I(ps_prop*ps_prop)*l_vmpfc2 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_r_ifg <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_ifg + I(ps_prop*ps_prop)*r_ifg + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_ifg <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ifg + I(ps_prop*ps_prop)*l_ifg + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_r_dlpfc <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_dlpfc + I(ps_prop*ps_prop)*r_dlpfc + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_dlpfc <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_dlpfc + I(ps_prop*ps_prop)*l_dlpfc + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_r_caudate <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_caudate + I(ps_prop*ps_prop)*r_caudate + ree + (1 | sub), data = lED_intake_long_LargevSmall)
led_model_l_caudate <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_caudate + I(ps_prop*ps_prop)*l_caudate + ree + (1 | sub), data = lED_intake_long_LargevSmall)


# summaries -- determine inclusion of quadratic term
summary(led_model_r_amygdala)
summary(led_model_l_amygdala)
summary(led_model_r_striatum) 
summary(led_model_l_striatum) 
summary(led_model_r_ofc2) #quad
summary(led_model_l_ofc2)
summary(led_model_r_vmpfc1)
summary(led_model_l_vmpfc1)
summary(led_model_r_vmpfc2) #quad
summary(led_model_l_vmpfc2)
summary(led_model_r_ifg)
summary(led_model_l_ifg)
summary(led_model_r_dlpfc)
summary(led_model_l_dlpfc)
summary(led_model_r_caudate)
summary(led_model_l_caudate)


# For ROIs where quadtratic terms are not significant, remove them for parsimony
lin_led_model_r_amygdala <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_amygdala + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_amygdala <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_amygdala + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_r_striatum <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_striatum + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_striatum <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_striatum + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_ofc2 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ofc2 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_r_vmpfc1 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_vmpfc1 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_vmpfc1 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc1 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_vmpfc2 <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_vmpfc2 + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_r_ifg <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_ifg + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_ifg <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_ifg + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_r_dlpfc <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_dlpfc + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_dlpfc <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_dlpfc + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_r_caudate <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*r_caudate + ree + (1 | sub), data = lED_intake_long_LargevSmall)
lin_led_model_l_caudate <- lmer(led_grams ~ preFF + avg_vas + meal_order + ps_prop*l_caudate + ree + (1 | sub), data = lED_intake_long_LargevSmall)

# summaries
summary(lin_led_model_r_amygdala) #lin
summary(lin_led_model_l_amygdala) # lin trend (.057)
summary(lin_led_model_r_striatum) 
summary(lin_led_model_l_striatum) 
summary(lin_led_model_l_ofc2)
summary(lin_led_model_r_vmpfc1)
summary(lin_led_model_l_vmpfc1)
summary(lin_led_model_l_vmpfc2)
summary(lin_led_model_r_ifg)
summary(lin_led_model_l_ifg)
summary(lin_led_model_r_dlpfc)
summary(lin_led_model_l_dlpfc)
summary(lin_led_model_r_caudate)
summary(lin_led_model_l_caudate)

```


https://vincentarelbundock.github.io/modelsummary/articles/modelsummary.html
```{r summary table}
library(modelsummary)

PS_roi1 <- intake_long_LargevSmall[,c("Mean_1","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi1)[which(names(PS_roi1) == "Mean_1")] <- "PS_BOLD"

PS_roi2 <- intake_long_LargevSmall[,c("Mean_2","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi2)[which(names(PS_roi2) == "Mean_2")] <- "PS_BOLD"

PS_roi4 <- intake_long_LargevSmall[,c("Mean_4","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi4)[which(names(PS_roi4) == "Mean_4")] <- "PS_BOLD"

PS_roi8 <- intake_long_LargevSmall[,c("Mean_8","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi8)[which(names(PS_roi8) == "Mean_8")] <- "PS_BOLD"

PS_roi16 <- intake_long_LargevSmall[,c("Mean_16","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi16)[which(names(PS_roi16) == "Mean_16")] <- "PS_BOLD"

PS_roi32 <- intake_long_LargevSmall[,c("Mean_32","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi32)[which(names(PS_roi32) == "Mean_32")] <- "PS_BOLD"

PS_roi64 <- intake_long_LargevSmall[,c("Mean_64","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi64)[which(names(PS_roi64) == "Mean_64")] <- "PS_BOLD"

PS_roi128 <- intake_long_LargevSmall[,c("Mean_128","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi128)[which(names(PS_roi128) == "Mean_128")] <- "PS_BOLD"

PS_roi256 <- intake_long_LargevSmall[,c("Mean_256","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi256)[which(names(PS_roi256) == "Mean_256")] <- "PS_BOLD"

PS_roi512 <- intake_long_LargevSmall[,c("Mean_512","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi512)[which(names(PS_roi512) == "Mean_512")] <- "PS_BOLD"

PS_roi1024 <- intake_long_LargevSmall[,c("Mean_1024","preFF","grams", "avg_vas", "meal_order", "ps_prop", "sub", "ree")]
colnames(PS_roi1024)[which(names(PS_roi1024) == "Mean_1024")] <- "PS_BOLD"


models_final <- list(
  "roi1" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + (1 | sub), data = PS_roi1),
  "roi2" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + (1 | sub), data = PS_roi2),
  "roi4" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + (1 | sub), data = PS_roi4),
  "roi8" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + I(ps_prop*ps_prop)*PS_BOLD + (1 | sub), data = PS_roi8),
  "roi16" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + I(ps_prop*ps_prop)*PS_BOLD + (1 | sub), data = PS_roi16),
  "roi32" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + I(ps_prop*ps_prop)*PS_BOLD + (1 | sub), data = PS_roi32),
  "roi64" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + (1 | sub), data = PS_roi64),
  "roi128" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + I(ps_prop*ps_prop)*PS_BOLD + (1 | sub), data = PS_roi128),
  "roi256" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + I(ps_prop*ps_prop)*PS_BOLD + (1 | sub), data = PS_roi256),
  "roi512" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + (1 | sub), data = PS_roi512),
  "roi1024" = lmer(grams ~ preFF + avg_vas + meal_order + ree + ps_prop*PS_BOLD + (1 | sub), data = PS_roi1024)
)

# specifiy # of digits to round to with fmt
modelsummary(models_final,
             estimate = "{estimate} ({std.error})",
             statistic = "{p.value}",
             fmt = fmt_statistic(estimate = 2, std.error = 2, p.value = 3))

modelsummary(models_final,
             estimate = "{estimate} ({std.error})",
             statistic = "{p.value}",
             fmt = 3)

# use stars for significance instead of printing p-value
# stars = TRUE uses these default values: `+ p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001`
modelsummary(models_final,
             fmt = 2,
             stars = TRUE)

# omit intercept and covariates
modelsummary(models_noquad,
             statistic = "{std.error} ({p.value})",
             coef_omit = 1:4)
```

#### Figures #### 

```{r plots with interact_plot, include=TRUE}
library(interactions)

interact_plot(model_r_ofc2, pred = ps_prop, modx = r_ofc2,  x.label = "portion size increase from reference", y.label = "grams eaten") + ylim(0, 600) + scale_x_continuous(breaks = seq(0, .99, by = .33))
interact_plot(model_l_ofc2, pred = ps_prop, modx = l_ofc2) + ylim(0, 600) + scale_x_continuous(breaks = seq(0, .99, by = .33))
interact_plot(model_r_vmpfc2, pred = ps_prop, modx = r_vmpfc2) + ylim(0, 600) + scale_x_continuous(breaks = seq(0, .99, by = .33))
interact_plot(model_l_vmpfc2, pred = ps_prop, modx = l_vmpfc2) + ylim(0, 600) + scale_x_continuous(breaks = seq(0, .99, by = .33))

# with confidence interval
interact_plot(model_l_ofc2, pred = ps_prop, modx = l_ofc2, interval = TRUE, int.width = 0.8)

# with points
interact_plot(model_r_ofc2, pred = ps_prop, modx = r_ofc2, plot.points = TRUE) + ylim(0, 1000)
interact_plot(model_l_ofc2, pred = ps_prop, modx = l_ofc2, plot.points = TRUE) + ylim(0, 1000)
interact_plot(model_r_vmpfc2, pred = ps_prop, modx = r_vmpfc2, plot.points = TRUE) + ylim(0, 1000)
interact_plot(model_l_vmpfc2, pred = ps_prop, modx = l_vmpfc2, plot.points = TRUE) + ylim(0, 1000)

```

```{r portion size plots by tertile, include=TRUE}

#### PS contrast - model_r_ofc2 ####

# split into tertiles by PS response
intake_long_LargevSmall <- intake_long_LargevSmall %>%
    mutate(tertile_r_ofc2 = ntile(r_ofc2, 3))

# Get mean & standard deviation of grams intake by group
r_ofc2 <- intake_long_LargevSmall %>% 
  drop_na(grams) %>%
  group_by(ps_prop, tertile_r_ofc2) %>%
  summarise_at(vars(grams),
               list(mean = mean,
                    sd = sd)) %>% 
  as.data.frame()

# change tertile and ps_prop to factors
r_ofc2$tertile_r_ofc2 <- as.factor(r_ofc2$tertile_r_ofc2)
r_ofc2$ps_prop <- as.factor(r_ofc2$ps_prop)

# plot
ggplot(r_ofc2, aes(x = ps_prop, y = mean, color = tertile_r_ofc2, group = tertile_r_ofc2)) +
  geom_point() + geom_line(size=2) +
  ylim(350, 600) +
  ggtitle("PSE by R OFC PS response") +
  ylab("Intake (grams)") +
  xlab("Meal portion size (proportion)") +
  labs(color = "neural PS response (tertile)")

#### PS contrast - model_l_ofc2 ####

# split into tertiles by PS response
intake_long_LargevSmall <- intake_long_LargevSmall %>%
    mutate(tertile_l_ofc2 = ntile(l_ofc2, 3))

# Get mean & standard deviation of grams intake by group
l_ofc2 <- intake_long_LargevSmall %>% 
  drop_na(grams) %>%
  group_by(ps_prop, tertile_l_ofc2) %>%
  summarise_at(vars(grams),
               list(mean = mean,
                    sd = sd)) %>% 
  as.data.frame()

# change tertile and ps_prop to factors
l_ofc2$tertile_l_ofc2 <- as.factor(l_ofc2$tertile_l_ofc2)
l_ofc2$ps_prop <- as.factor(l_ofc2$ps_prop)

# plot
ggplot(l_ofc2, aes(x = ps_prop, y = mean, color = tertile_l_ofc2, group = tertile_l_ofc2)) +
  geom_point() + geom_line(size=2) +
  ylim(350, 600) +
  ggtitle("PSE by L OFC PS response") +
  ylab("Intake (grams)") +
  xlab("Meal portion size (proportion)") +
  labs(color = "neural PS response (tertile)")



#### PS contrast - model_r_vmpfc2 ####

# split into tertiles by PS response
intake_long_LargevSmall <- intake_long_LargevSmall %>%
    mutate(tertile_r_vmpfc2 = ntile(r_vmpfc2, 3))

# Get mean & standard deviation of grams intake by group
r_vmpfc2 <- intake_long_LargevSmall %>% 
  drop_na(grams) %>%
  group_by(ps_prop, tertile_r_vmpfc2) %>%
  summarise_at(vars(grams),
               list(mean = mean,
                    sd = sd)) %>% 
  as.data.frame()

# change tertile and ps_prop to factors
r_vmpfc2$tertile_r_vmpfc2 <- as.factor(r_vmpfc2$tertile_r_vmpfc2)
r_vmpfc2$ps_prop <- as.factor(r_vmpfc2$ps_prop)

# plot
ggplot(r_vmpfc2, aes(x = ps_prop, y = mean, color = tertile_r_vmpfc2, group = tertile_r_vmpfc2)) +
  geom_point() + geom_line(size=2) +
  ylim(350, 600) +
  ggtitle("PSE by R vmpfc PS response") +
  ylab("Intake (grams)") +
  xlab("Meal portion size (proportion)") +
  labs(color = "neural PS response (tertile)")

#### PS contrast - model_l_vmpfc2 ####

# split into tertiles by PS response
intake_long_LargevSmall <- intake_long_LargevSmall %>%
    mutate(tertile_l_vmpfc2 = ntile(l_vmpfc2, 3))

# Get mean & standard deviation of grams intake by group
l_vmpfc2 <- intake_long_LargevSmall %>% 
  drop_na(grams) %>%
  group_by(ps_prop, tertile_l_vmpfc2) %>%
  summarise_at(vars(grams),
               list(mean = mean,
                    sd = sd)) %>% 
  as.data.frame()

# change tertile and ps_prop to factors
l_vmpfc2$tertile_l_vmpfc2 <- as.factor(l_vmpfc2$tertile_l_vmpfc2)
l_vmpfc2$ps_prop <- as.factor(l_vmpfc2$ps_prop)

# plot
ggplot(l_vmpfc2, aes(x = ps_prop, y = mean, color = tertile_l_vmpfc2, group = tertile_l_vmpfc2)) +
  geom_point() + geom_line(size=2) +
  ylim(350, 600) +
  ggtitle("PSE by L vmpfc PS response") +
  ylab("Intake (grams)") +
  xlab("Meal portion size (proportion)") +
  labs(color = "neural PS response (tertile)")

```

